# 前端部署

## 一、静态资源处理
1. 为了最大程度利用缓存，将页面入口(HTML)设置为协商缓存，将 JavaScript、CSS 等静态资源设置为永久强缓存。

2. 为了解决强缓存更新问题，将文件摘要（hash）作为资源路径(URL)构成的一部分。
3. 为了解决覆盖式发布引发的问题，采用 name-hash 而非 query-hash 的组织方式，具体需要配置 Wbpack 的 output.filename 为 contenthash 。
4. 为了解决 Nginx 目录存储过大 + 结合 CDN 提升访问速度，采用了 Nginx 反向代理+ 将静态资源上传到 CDN。
5. 为了上传 CDN，我们需要按环境动态构造 publicPath + 按环境构造 CDN 上传目录并上传。
6. 为了动态构造 publicPath 并且随构建过程插入到 HTML 中，采用 Webpack-HTML-Plugin 等插件，将编译好的带 hash + publicPath 的静态资源插入到 HTML 中。
7. 为了保证上传 CDN 的安全，我们需要一种机制管控上传 CDN 秘钥，而非简单的将秘钥写到代码 / Dockerfile 等明文文件中。

## 二、自动化构建

### 2.1构建基本流程

拉取远程仓库

切换到 XX 分支

代码安全检查（非必选）、单元测试等等

安装 npm/yarn 依赖

安装依赖等

执行编译 & 构建

产物检查（比如检测打包后 JS 文件 / 图片大小、产物是否安全等，保证产物质量，非必选）

人工卡点（非必选，如必须 Leader 审批通过才能继续）

打包上传 CDN

自动化测试（非必选，e2e）

配套剩余其他步骤

通知构建完成

### 2.2 常用工具

保证环境一致性：Docker

按流程构建：Jenkins

自动化构建触发：Gitlab webhook 通知

开始构建通知：依赖账号体系打通+ Gitlab Webhook

构建完成通知：依赖账号体系打通

## 三、常见问题


> Q: 前端代码从 tsx/jsx 到部署上线被用户访问，中间大致会经历哪些过程？

A: 经历本地开发、远程构建打包部署、安全检查、上传CDN、Nginx做流量转发、对静态资源做若干加工处理等过程。

> Q：可能大部分同学都知道强缓存/协商缓存，那前端各种产物（HTML、JS、CSS、IMAGES 等）应该用什么缓存策略？以及为什么？
若使用协商缓存，但静态资源却不频繁更新，如何避免协商过程的请求浪费？
若使用强缓存，那静态资源如何更新？

A：HTML使用协商缓存，静态资源使用强缓存，使用name-hash（非覆盖式发布）解决静态资源更新问题。

> Q：配套的，前端静态资源应该如何组织？

A：搭配 Webpack 的Webpack_HTML-Plugin & 配置 output publicPath等。

> Q：配套的，自动化构建 & 部署过程如何与 CDN 结合？

A：自动化构建打包后，将产物传输到对应环境 URL 的CDN上。

> Q：如何避免前端上线，影响未刷新页面的用户？

A：使用name-hash方式组织静态资源，先上线静态资源，再上线HTML。

> Q：刚上线的版本发现有阻塞性 bug，如何做到秒级回滚，而非再次部署等 20 分钟甚至更久？

A：HTML文件使用非覆盖方式存储在CDN上，搭建前端发布服务，对 HTML 按版本等做缓存加工处理。当需要回滚时，更改发布服务HTMl指向即可。

> Q: CDN 域名突然挂了，如何实现秒级 CDN 降级修补而非再次全部业务重新部署一次？

A1: 将静态资源传输到多个 CDN 上，并开发一个加载Script的SDK集成到HTML中。当发现CDN资源加载失败时，逐步降级CDN域名。

A2：在前端发布服务中，增加HTML文本处理环节，如增加CDN域名替换，发生异常时，在发布服务中一键设置即可。

> Q：如何实现一个预发环境，除了前端资源外都是线上环境，将变量控制前端环境内？

A：对静态资源做加工，对HTML入口做小流量。

> Q：如何实现一套前端代码，发布成多套环境产物？

A：使用环境变量，将当前环境、CDN、CDN_HOST、Version等注入环境变量中，构建时消费 & 将产物上传不同的CDN即可。
